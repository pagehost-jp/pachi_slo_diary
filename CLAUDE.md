# プロジェクトメモ

## 重要ルール
- **コード変更後は必ず `sw.js` の `CACHE_NAME` のバージョンを上げる**（例: v17 → v18）
- プッシュも忘れずに

## 用語
- **TOP** = 一覧画面（月別リスト表示）のこと

## 画面構成
1. 一覧画面（TOP）- 月別の収支リスト・カレンダー表示 ← 起動時に開く
2. 収支入力画面 - 「+ 収支を入力」ボタンから開く

---

# 🛡️ 今後のWebアプリ開発ガイドライン

## データ消失事件の教訓
**発生した問題**: アイコン未設定の古いバージョンでPWAインストール → アプリ削除で全データ消失

**原因**:
- Firebaseクラウド同期機能はあったが、ログインしていなかった
- データがIndexedDB（ブラウザ内）のみに保存されていた
- アプリ削除 = IndexedDB削除 → データ完全消失

---

## 【最優先】初期実装で必須の機能

### 1. PWA設定（1日目に完成させる）
- ✅ manifest.json（アプリ名、説明）
- ✅ アイコン画像 192px & 512px（必ず用意）
- ✅ Service Worker（sw.js）
  - キャッシュ名: v1 から開始
  - 更新時は必ずバージョンアップ

**重要**: アイコンなしで公開しない

### 2. データ永続化（初日必須）
**必ずクラウド同期を実装する**

- ✅ Firebase/Supabase等のクラウドDB
- ✅ ログイン機能（Google認証推奨）
- ✅ **ログインしていない場合の警告**
  ```
  「⚠️ ログインしないとデータが消える可能性があります」
  ```
- ✅ IndexedDBはオフライン補助のみ

**絶対禁止**: ローカルストレージのみでの運用

### 3. データ保護機能（初期実装）
- ✅ データエクスポート（JSON/CSV）
- ✅ データインポート（復元用）
- ✅ 設定画面に「バックアップ」ボタン
- ✅ 定期バックアップの促し通知

### 4. ユーザー保護
- ✅ 削除操作は必ず確認ダイアログ
- ✅ 「アプリ削除=データ消失」の警告
- ✅ 初回起動時のチュートリアル
  - ログインの重要性
  - バックアップの取り方

### 5. 開発フロー
1. Git初期化
2. PWA設定完成（アイコン含む）
3. クラウドDB + ログイン実装
4. バックアップ機能実装
5. ← **ここまで完成してから公開**

---

## 実装順序（厳守）

```
Day 1:
  1. Gitリポジトリ作成
  2. manifest.json + アイコン
  3. Firebase/Supabase設定
  4. ログイン機能
  5. Firestore保存実装

Day 2:
  6. IndexedDB（オフライン用）
  7. Service Worker
  8. エクスポート/インポート機能

Day 3以降:
  9. 個別機能開発
```

---

## ❌ 絶対にやってはいけないこと

1. アイコンなしでPWA公開
2. ローカルストレージのみで運用
3. ログイン機能を後回し
4. バックアップ機能を後回し
5. 古いキャッシュバージョンのまま更新

---

## ✅ 重要な教訓

- PWAは便利だが、古いバージョンでインストールされると更新が困難
- クラウド同期があってもログインしないと意味がない
- データ保護は「あとで追加」では遅い
- **初期設計が全て**

---

# 📦 容量管理システム

## 現在の実装

### データ保存方式
- **Firestore**に画像を含む全データを保存
- 画像は圧縮後（幅1200px、品質80%）のbase64で保存
- Firebase Storageは使用しない（無料プランでは利用不可）

### 容量監視
- **設定画面で使用量を表示**
  - リアルタイムで全データのサイズを計算
  - 視覚的なプログレスバー表示
  - 色分け：緑（〜500MB）/ オレンジ（500〜800MB）/ 赤（800MB〜）

- **警告システム**
  - 800MB超過で警告表示
  - 無料枠（1GB）の残り容量を常に確認可能

### 容量削減施策
- 画像圧縮（幅1200px、品質80%）
- 1日3画像アップロードで約3〜4年使用可能

---

## 🔮 今後の拡張計画

### Phase 1: 容量が700MB超えたら
**実装する機能**：
1. **データエクスポート機能**
   - 全データをJSON形式でダウンロード
   - バックアップとして保存

2. **データインポート機能**
   - JSONファイルから復元
   - 誤削除時の救済

### Phase 2: 容量が800MB超えたら
**実装する機能**：
1. **古いデータ一覧表示**
   - 1年以上前のデータを表示
   - 削除候補として提案

2. **選択削除機能**
   - チェックボックスで複数選択
   - 一括削除ボタン

3. **画像のみ削除オプション**
   - データは残して画像だけ削除
   - 容量を大幅削減

### Phase 3: 容量が900MB超えたら
**実装する機能**：
1. **自動アーカイブ機能**
   - 古いデータを自動でエクスポート
   - クラウドから削除、ローカルに保存

2. **年度別管理**
   - 年度ごとにアーカイブ
   - 必要に応じて復元

3. **有料プラン案内**
   - Firebase Blazeプランの説明
   - アップグレード方法のガイド

---

## 実装メモ

### 容量計算方法
```javascript
// 全エントリーのJSONサイズを合計
const snapshot = await firestoreDb
  .collection('users')
  .doc(currentUser.uid)
  .collection('entries')
  .get();

let totalBytes = 0;
snapshot.forEach(doc => {
  const jsonStr = JSON.stringify(doc.data());
  totalBytes += new Blob([jsonStr]).size;
});
```

### 警告閾値
- 500MB: オレンジ表示（注意）
- 800MB: 赤表示 + 警告メッセージ
- 900MB: 削除機能の案内
- 1000MB: 緊急警告

### データ削除の優先順位
1. 最も古いデータ（2年以上前）
2. 画像が大きいデータ
3. 画像のみ削除（テキストは残す）
